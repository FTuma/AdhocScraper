# -*- coding: utf-8 -*-
import scrapy
from scrapy.loader import ItemLoader
from adhocScraper.items import ArivaStockItem
from datetime import datetime

ALL_STOCKS_ISIN = ['DE000A0WMNK9',
                   'DE0005403901',
                   'DE000A2TSL22',
                   'DE000A2LQUA5',
                   'DE0008232125',
                   'DE0005493365',
                   'DE000KBX1006',
                   'DE000A1TNU68',
                   'DE0007257503',
                   'DE000A168114',
                   'CH0038389992',
                   'DE000KC01000',
                   'DE0006450000',
                   'DE000SYM9999',
                   'DE000A2E4T77',
                   'DE0005146807',
                   'CNE1000031C1',
                   'DE0006202005',
                   'DE000A12UK08',
                   'DE0005810055',
                   'DE000A1MMCC8',
                   'DE0005066609',
                   'DE000A0XYGA7',
                   'LU1377527517',
                   'DE0006766504',
                   'DE0005552004',
                   'GB00BF1GH114',
                   'DE000A0WMJQ4',
                   'DE000A161NR7',
                   'DE000UNSE018',
                   'CH0012488190',
                   'CH0110303119',
                   'CH0106213793',
                   'NL0000238145',
                   'LU1296758029',
                   'CH0404880129',
                   'CH0024590272',
                   'CH0244017502',
                   'CH0007162958',
                   'DE000TCAG172',
                   'DE0005199905',
                   'DE000ZAL1111',
                   'CH0038285679',
                   'DE0008019001',
                   'CH0033813293',
                   'XS0216072230',
                   'CH0100837282',
                   'DE000A0EUBN9',
                   'DE000A2NBZ21',
                   'DE000A2LQ900',
                   'DE000A2GS401',
                   'DE0005313704',
                   'DE0005194062',
                   'DE000A1MME74',
                   'DE000A0HNF96',
                   'DE0005550602',
                   'DE000A0JC8S7',
                   'CH0028200837',
                   'NL0012044747',
                   'CH0024736404',
                   'DE000A0JJTG7',
                   'DE000WAF3001',
                   'AT0000741053',
                   'DE000A2NBTL2',
                   'DE000A2NB650',
                   'DE0005137004',
                   'DE000A2E3772',
                   'DE000A0JL9W6',
                   'DE000A0ETBQ4',
                   'DE0005190003',
                   'DE000A1TNUT7',
                   'DE000A2E4L42',
                   'DE000A0B65S3',
                   'DE0005313506',
                   'DE000A0AHT46',
                   'DE000A2AA204',
                   'CH0132594711',
                   'SE0011614445',
                   'MT0000580101',
                   'DE0008042003',
                   'DE0005751986',
                   'DE0003304101',
                   'DE0007203705',
                   'DE000A0MW975',
                   'CH0386200239',
                   'DE0005558696',
                   'DE000A14KRD3',
                   'DE0007667107',
                   'DE000A1TNNN5',
                   'CH0011108872',
                   'DE000A0L1NN5',
                   'DE000TUAG000',
                   'AT0000A0K1J1',
                   'DE0005400667',
                   'DE0005102008',
                   'DE0005008007',
                   'DE000LED4000',
                   'DE000A111338',
                   'LU1404975507',
                   'DE0005009740',
                   'DE0007472060',
                   'DE0005659700',
                   'LU1066226637',
                   'DE0007297004',
                   'DE0006231004',
                   'DE0005479307',
                   'DE0005545503',
                   'CH0017875789',
                   'DE0005089031',
                   'DE0005156236',
                   'DE000A2E3707',
                   'DE0007493991',
                   'AT0000A00Y78',
                   'DE000A2GS633',
                   'LU1618151879',
                   'DE000A0LAUP1',
                   'DE0006046113',
                   'DE000A0B9N37',
                   'DE0006569908',
                   'DE0008430026',
                   'DE0006084403',
                   'DE000PAT1AG3',
                   'DE000A0STST2',
                   'DE0006083405',
                   'DE000HLAG475',
                   'DE0005855183',
                   'DE0007775231',
                   'DE0006972508',
                   'DE0005140008',
                   'DE000CBK1001',
                   'DE0005408884',
                   'DE000A0JCY11',
                   'DE0005654933',
                   'CH0003245351',
                   'FI4000106299',
                   'DE000A1X3VZ3',
                   'DE0007664039',
                   'DE000A0DPRE6',
                   'DE000A1RFM03',
                   'DE0007276503',
                   'DE0005227235',
                   'DE000LEG1110',
                   'DE000A0JBPG2',
                   'DE0006578008',
                   'DE000WACK012',
                   'DE0007448508',
                   'DE000A2NBX80',
                   'DE000WCH8881',
                   'DE0005759807',
                   'DE000A13SH22',
                   'DE000A1DAHH0',
                   'DE000A2PBE40',
                   'DE000A2GS2C7',
                   'CH0406705126',
                   'DE0005937007',
                   'DE000A0XYHT5',
                   'DE000A11QW50',
                   'DE000EVNK013',
                   'DE000A0JKHC9',
                   'XS1433231377',
                   'DE000A0Z23Q5',
                   'DE0006969603',
                   'DE000A2GS5D8',
                   'DE0005200000',
                   'NL0000233195',
                   'DE0006599905',
                   'DE0007507501',
                   'DE0005488100',
                   'DE0006464506',
                   'DE0005493092',
                   'DE000A0N4N52',
                   'DE0005489561',
                   'DE000A19WVN8',
                   'DE000VTG9999',
                   'LU0307018795',
                   'DE000XNG8888',
                   'DE0005437305',
                   'DE0005800601',
                   'DE0005494165',
                   'DE0006632003',
                   'DE0005408116',
                   'DE0007856023',
                   'DE0005785802',
                   'DE0007446007',
                   'DE000A2G9LL1',
                   'DE0008404005',
                   'DE0007501009',
                   'DE000A12DM80',
                   'DE000A12UPJ7',
                   'DE000A14KEB5',
                   'DE0005677108',
                   'DE0007100000',
                   'DE0005932735',
                   'DE0007846867',
                   'AT0000746409',
                   'DE000WNDL193',
                   'DE000A0KFKB3',
                   'DE0006061104',
                   'DE0006602006',
                   'DE000A2JNWZ9',
                   'DE0007568578',
                   'DE000A0EPUH1',
                   'DE0005178008',
                   'DE000A1TNWJ4',
                   'DE000A12B8Z4',
                   'SE0006027546',
                   'DE0007571424',
                   'DE000A1K0235',
                   'DE0005104400',
                   'DE000A1JBPV9',
                   'CH0028422100',
                   'CH0004870942',
                   'DE000A1681X5',
                   'DE0007314007',
                   'DE0006595101',
                   'DE000A1EMG56',
                   'DE000A2G8XX3',
                   'DE0005156004',
                   'DE0007480204',
                   'DE000A0MZ4B0',
                   'DE000A161408',
                   'DE0006048432',
                   'DE000A2LQ850',
                   'DE0005104806',
                   'DE0005470405',
                   'DE000LTT0243',
                   'DE0006452907',
                   'DE0006204407',
                   'DE0005439004',
                   'DE000A0CAYB2',
                   'DE000A0LD2U1',
                   'DE000A0XFSF0',
                   'AT0000A21KS2',
                   'DE0007042301',
                   'DE000FTG1111',
                   'DE000A0B6VN9',
                   'DE0005470306',
                   'DE000A2E4K43',
                   'DE000A1A6V48',
                   'DE000A2E4SV8',
                   'DE0005664809',
                   'DE000A0BVU28',
                   'DE0006097108',
                   'DE0005176903',
                   'DE0007037129',
                   'DE0009842542',
                   'DE0006483001',
                   'DE0006286560',
                   'DE0005565204',
                   'DE0006305006',
                   'DE0007235301',
                   'DE000A12UP29',
                   'DE000A1X3XX4',
                   'DE0005785604',
                   'DE000A2NBVD5',
                   'DE000A0DJ6J9',
                   'DE000A1MMCR6',
                   'DE000A1K03W5',
                   'DE000A1TNV91',
                   'DE000KSAG888',
                   'DE0006001902',
                   'DE000A12UP37',
                   'DE000A2G9MZ9',
                   'DE000A2E4LE9',
                   'DE0007030009',
                   'DE000BAY0017',
                   'DE000SKWM021',
                   'DE0005286108',
                   'DE000A0Z23G6',
                   'XS1074935492',
                   'XS1074935062',
                   'DE0006062144',
                   'DE0006200108',
                   'DE000A0B9VV6',
                   'DE000A2DAM03',
                   'DE000A0Z1JH9',
                   'LU1250154413',
                   'DE000A2GS625',
                   'AT00BUWOG001',
                   'DE0005110001',
                   'DE0007251803',
                   'DE000A1X3WF3',
                   'DE0007164600',
                   'DE000A11Q059',
                   'CH0413237394',
                   'DE000A2AADD2',
                   'DE000A2NB122',
                   'DE000A1H8MU2',
                   'DE000PSM7770',
                   'DE000A0KFUJ5',
                   'DE000A189CF6',
                   'DE0007500001',
                   'NL0012377394',
                   'DE0005232805',
                   'DE000A1K0300',
                   'NL0012169213',
                   'DE000A2DA414',
                   'DE000A1EWWW0',
                   'LU0472835155',
                   'DE0005909006',
                   'DE0007201907',
                   'GB0059822006',
                   'DE000A2E4K76',
                   'US92912L1070',
                   'DE0006916604',
                   'DE0005859698',
                   'DE000A2DA588',
                   'CH0435377954',
                   'DE000SHA0159',
                   'DE000DWS1007',
                   'DE000A0Z2Y48',
                   'DE0005874846',
                   'AT0000818802',
                   'DE0006335003',
                   'DE000A0WMPJ6',
                   'DE0006042708',
                   'DE0005498901',
                   'DE0005790430',
                   'DE000A1YCRY6',
                   'DE0007461006',
                   'DE0006968001',
                   'DE0006047004',
                   'DE0007231326',
                   'AT0000938204',
                   'DE000PAH0038',
                   'CH0303692047',
                   'DE0006757008',
                   'DE000A0Z2XN6',
                   'DE000TLX1005',
                   'DE0005895403',
                   'DE000A11QVV0',
                   'DE0005093108',
                   'DE0005493654',
                   'DE000A0SMU87',
                   'DE000A2N4H07',
                   'DE0005936124',
                   'DE000STRA555',
                   'DE000A2E4L00',
                   'AT0000A0U9J2',
                   'CH0367465439',
                   'DE000A2LQ009',
                   'DE0005492938',
                   'DE000BASF111',
                   'CH0207961084',
                   'DE000A12UKK6',
                   'DE000A0V9L94',
                   'DE0005634000',
                   'DE000A11QGV1',
                   'DE000A12ULL2',
                   'DE000BFB0019',
                   'DE000A0STSQ8',
                   'DE0007074007',
                   'DE000A2GS5M9',
                   'DE000A0LBFE4',
                   'DE000A0KEXC7',
                   'CH0003583256',
                   'LU1072910919',
                   'DE0005419105',
                   'GB00B61DTR94',
                   'DE000A1MMEV4',
                   'DE000A0JK2A8',
                   'DE0006636681',
                   'DE0008402215',
                   'DE0006292030',
                   'DE0001218063',
                   'DE000A0XYG76',
                   'DE000A0HGQF5',
                   'DE0008364902',
                   'DE0007236101',
                   'DE0005773303',
                   'XS1413726883',
                   'DE000A1MLSJ1',
                   'DE000A2G8X31',
                   'DE0005407100',
                   'DE0007239402',
                   'DE000A1H8BV3',
                   'DE000A0JQ5U3',
                   'DE000JST4000',
                   'DE0005495329',
                   'DE000ENAG999',
                   'CH0298294981',
                   'DE0005428007',
                   'DE000A2NB601',
                   'DE0005158703',
                   'DE000A0LD6E6',
                   'CH0132106482',
                   'DE000A1K0227',
                   'DE000A11Q133',
                   'DE000A13SX22',
                   'DE000A11QU78',
                   'DE000A0Z2ZZ5',
                   'DE0005492276',
                   'DE000A1YDDM9',
                   'DE0005772206',
                   'DE000ZDWT018',
                   'DE000A0LBKW6',
                   'DE0006219934',
                   'DE000A161234',
                   'DE000A1ML7J1',
                   'DE000A2G9M17',
                   'DE000A1X3YY0',
                   'DE0005407506',
                   'DE000A161N30',
                   'CH0033050961',
                   'DE0006208408',
                   'DE000A0KF6M8',
                   'DE000A0KD0F7',
                   'DE000A1K0201',
                   'DE000A168478',
                   'DE0006070006',
                   'DE000SPG1003',
                   'DE0007830788',
                   'DE000RYSE888',
                   'DE000A1J5RX9',
                   'DE000A19MDV0',
                   'DE000A11QW68',
                   'DE000A0BVU93',
                   'DE0005141907',
                   'DE000A0EQ578',
                   'DE0005495626',
                   'AT0000606306',
                   'DE000A2GSWR1',
                   'DE000A0L1H32',
                   'DE0008051004',
                   'DE000A0S8488',
                   'DE0007830572',
                   'DE0009147207',
                   'DE000A0H1GY2',
                   'DE000A0KFKH0',
                   'DE000SHL1006',
                   'DE0005203947',
                   'DE0006095003',
                   'CH0012885841',
                   'DE000A1PHBB5',
                   'DE000A0HL8N9',
                   'CH0006539198',
                   'DE000HSH2H15',
                   'LU0538936351',
                   'DE000A1K0375',
                   'DE0005118806',
                   'DE000A0KPPR7',
                   'DE0006223407',
                   'CH0001931853',
                   'DE000A0D6554',
                   'DE000A0HN4T3',
                   'DE0005168108',
                   'CH0012815459',
                   'DE0006924400',
                   'DE0005501357',
                   'GB00B128C026',
                   'DE000CHEN993',
                   'AT0000785407',
                   'DE0008592759',
                   'DE0005201602',
                   'CH0024666528',
                   'DE000A1X3X33',
                   'DE0006013006',
                   'DE0005557508',
                   'XS0935786789',
                   'LU1704650164',
                   'AT0000697750',
                   'DE000A184P98',
                   'DE000A0TGJ55',
                   'DE000KGX8881',
                   'DE0007165607',
                   'DE0005875306',
                   'DE000FPH9000',
                   'XS0955817738',
                   'CH0118530366',
                   'DE000DGAS529',
                   'DE000A2E4MK4',
                   'DE000A0HN5C6',
                   'DE000A0LR936',
                   'DE0005111702',
                   'DE000A1TNA39',
                   'DE0005494538',
                   'DE0005103006',
                   'DE000A0AYXP8',
                   'DE0006053952',
                   'DE0008303504',
                   'DE0006053101',
                   'DE000A0KF6S5',
                   'DE000A1YCMM2',
                   'DE000A0BL849',
                   'DE0007010803',
                   'DE000A0HHJR3',
                   'DE000A2GSL68',
                   'XS0626438112',
                   'DE000A14KL72',
                   'DE000A161F97',
                   'DE000A2AA402',
                   'XC000A1ELUR9',
                   'IL0010837248',
                   'DE0006069008',
                   'MT0001180109',
                   'SE0002627141',
                   'CH0148052126',
                   'DE0005130108',
                   'DE000A161GE9',
                   'DE000A12UL56',
                   'DE000A0DLU51',
                   'DE000A1MBDZ0',
                   'DE000A0DNAY5',
                   'DE000A1PHFF7',
                   'DE000A1MMHE3',
                   'DE0005774103',
                   'LU1075065190',
                   'AT0000640552',
                   'DE000A161440',
                   'DE000A1X3X66',
                   'US7750431022',
                   'XS1216646825',
                   'AT0000A1DNL2',
                   'DE0006224520',
                   'AT0000A02177',
                   'DE000A2ASHC7',
                   'DE000A1G9AQ4',
                   'DE0007269003',
                   'DE0008286006',
                   'DE000A1PHEL8',
                   'CH0010819867',
                   'US2536511031',
                   'CH0011025217',
                   'DE000A1EMAK2',
                   'DE000A0JL461',
                   'DE0005758304',
                   'CH0003390066',
                   'DE0005021307',
                   'DE000A0DN1J4',
                   'DE000A1E8H38',
                   'DE000A14KR50',
                   'CH0001366332',
                   'DE000PRME020',
                   'DE0005878003',
                   'GB00BHD66J44',
                   'DE000A0D9PT0',
                   'XS0237509293',
                   'DE0006614712',
                   'DE0006102007',
                   'NL0000235190',
                   'DE000A0DZJZ7',
                   'DE000A2TSU21',
                   'DE0007490724',
                   'DE000A0AMCG6',
                   'DE0005487953',
                   'DE0007008906',
                   'DE000A0M6M79',
                   'CH0024899483',
                   'DE0005492540',
                   'DE000PLD5558',
                   'DE000A1JH3F9',
                   'DE0006082001',
                   'DE0007788408',
                   'DE000A1EL8Y8',
                   'SE0007331608',
                   'DE0005773006',
                   'DE000KD88880',
                   'DE0006913304',
                   'DE000A2TSM88',
                   'DE0005072300',
                   'DE000PET1111',
                   'DE000A161002',
                   'DE000A0WMLD8',
                   'DE000CBR1111',
                   'DE000A13SX89',
                   'DE000SKYD000',
                   'IL0010905052',
                   'CH0242606942',
                   'CH0211816381',
                   'LU0269583422',
                   'IL0010838071',
                   'DE0005167902',
                   'DE0005854343',
                   'DE000A161N14',
                   'DE000A1KREX3',
                   'DE000CLS1001',
                   'US0394831020',
                   'DE0005297204',
                   'DE0005220909',
                   'DE0005761159',
                   'DE0005240709',
                   'DE0007608606',
                   'DE000A1PG8V8',
                   'DE000A0B95Y8',
                   'DE000A1RFMM9',
                   'DE000A1PG7W8',
                   'DE0007551400',
                   'CH0010570759',
                   'DE000A0JM634',
                   'DE000GSW1111',
                   'DE000A1TNS70',
                   'DE0005647937',
                   'DE000A1APTA4',
                   'DE000A1E84A4',
                   'DE000A0V9A22',
                   'DE0006913403',
                   'DE000A0H52F5',
                   'DE000A1PHFG5',
                   'AT0000911805',
                   'DE000A0AFGF3',
                   'DE000A0B7EZ7',
                   'DE000A0BVWY6',
                   'DE000A1TNS13',
                   'DE000A1X3W34',
                   'DE000A0JDU97',
                   'DE0005487904',
                   'DE000A1KRLR0',
                   'DE000A2LQ728',
                   'DE000A1TNLL3',
                   'AT0000747555',
                   'DE0007454902',
                   'DE000A0BU964',
                   'CH0268536338',
                   'DE0006492903',
                   'CH0108753523',
                   'NL0012293995',
                   'DE0006610314',
                   'DE000A1R1EE6',
                   'DE0008405002',
                   'DE0001262186',
                   'DE000A1TNMM9',
                   'DE000A11QXV6',
                   'AT0000995006',
                   'DE0005155030',
                   'DE0006264005',
                   'AT0000834007',
                   'DE000PRME012',
                   'CA4598751002',
                   'DE000A1YCQ45',
                   'DE0007803009',
                   'DE000A1R1C81',
                   'DE000A1KRCK4',
                   'DE0005490155',
                   'DE000A0STYL7',
                   'DE0005501456',
                   'CH0022237009',
                   'DE0005204705',
                   'DE0001365880',
                   'CH0012192198',
                   'DE000A0N3EJ6',
                   'DE000DCAG010',
                   'CH0003455034',
                   'DE0005218309',
                   'DE000A0NUTV5',
                   'DE0005591036',
                   'DE000A0F6MD5',
                   'DE0008115106',
                   'DE000A1E8NW9',
                   'DE0007041105',
                   'DE000A1TNRR7',
                   'DE0006889801',
                   'DE0007657231',
                   'DE0007300402',
                   'DE0005081608',
                   'DE0006228406',
                   'DE000A0AEBS0',
                   'DE0005157101',
                   'DE0006627201',
                   'DE0005753149',
                   'AT0000A02Z18',
                   'DE000A1A6XX4',
                   'AT0000A0VCT2',
                   'DE000A0N4P43',
                   'DE000LB0ALR4',
                   'AT0000800800',
                   'DE0006911902',
                   'DE0005658009',
                   'XS0142391894',
                   'DE000A0MVLS8',
                   'SE0000722365',
                   'AT0000820659',
                   'DE000A1KQ8K4',
                   'DE0007220782',
                   'DE0005896005',
                   'DE000A1KRMR8',
                   'DE0008063306',
                   'DE0007229007',
                   'DE0005429906',
                   'CH0003504856',
                   'DE0005558662',
                   'DE0005085005',
                   'AT0000A0E9W5',
                   'DE000A0D6612',
                   'DE0006764749',
                   'DE000A0JKHG0',
                   'DE0005122006',
                   'DE000A0EPU98',
                   'DE0005461602',
                   'DE0005085609',
                   'DE0005220008',
                   'DE0007572406',
                   'DE0007504508',
                   'DE000A0LR456',
                   'LU0251710041',
                   'DE0002210853',
                   'DE0008076001',
                   'XS0169058012',
                   'DE0006949555',
                   'DE000A161077',
                   'AT0000652011',
                   'DE000A1RFM45',
                   'DE000BLB25M0',
                   'DE0005070908',
                   'DE000A0JCZ51',
                   'CH0034183175',
                   'DE0008107921',
                   'DE0006910938',
                   'NL0009538008',
                   'DE0005577001',
                   'CH0111677362',
                   'DE0006916406',
                   'DE000A1H6YK2',
                   'DE000A0F47J1',
                   'DE0005121701',
                   'DE000A0RAK01',
                   'DE0006201403',
                   'DE000A0LBRM2',
                   'DE000A0S84W0',
                   'AT0000776307',
                   'DE0006338007',
                   'DE000A1E8G88',
                   'DE0003304374',
                   'DE0005046304',
                   'DE0006622301',
                   'DE0006780000',
                   'DE0005407407',
                   'DE000A1EWNF4',
                   'US45170X1063',
                   'DE000A0JKYP6',
                   'DE0006372626',
                   'NL0000268456',
                   'DE000A14KR27',
                   'DE000A0EKLW0',
                   'DE000SBGS111',
                   'DE0007600801',
                   'DE0007850000',
                   'AT0000969985',
                   'DE000A1EMFF1',
                   'DE0008418526',
                   'DE000A0XYL53',
                   'DE0005239701',
                   'DE0007240004',
                   'DE000A0GQKR4',
                   'AT0000642806',
                   'DE000A0LBKV8',
                   'DE0006580806',
                   'DE0005088108',
                   'DE0005229942',
                   'DE0006257009',
                   'DE000A0L1NQ8',
                   'DE0008042870',
                   'CH0042821089',
                   'DE000A1A60H7',
                   'IL0003570129',
                   'IL0010845324',
                   'DE0007471195',
                   'DE000A0XFWK2',
                   'DE000A1682B9',
                   'DE0005290704',
                   'DE000A161Z44',
                   'DE0006656101',
                   'DE000LHS4000',
                   'DE0005125603',
                   'DE0008027707',
                   'DE0005800809',
                   'DE0005072102',
                   'DE0005471809',
                   'DE000A0KFRM5',
                   'DE000A0JC0A2',
                   'DE000A0MF053',
                   'DE0007221905',
                   'DE000A0STYJ1',
                   'DE0005179006',
                   'DE000A0XYL04',
                   'DE000A0AM9S2',
                   'DE0005256507',
                   'DE000A0J2LC4',
                   'DE0005083208',
                   'DE0007057705',
                   'DE000A1EWXW8',
                   'DE0005009104',
                   'DE0006851603',
                   'DE0005710503',
                   'DE0008084047',
                   'DE0007756009',
                   'DE0005013007',
                   'DE000A1E89S5',
                   'NL0000229458',
                   'DE0006214687',
                   'DE0005204606',
                   'DE0005085906',
                   'DE0005489306',
                   'DE0005348403',
                   'DE0005471601',
                   'DE000A0KAJP6',
                   'DE0007627200',
                   'DE0005117006',
                   'DE000A0RAS03',
                   'DE000A0AUJ90',
                   'DE000A1E8HY7',
                   'DE0006781008',
                   'DE0005546006',
                   'DE000A0L1NK1',
                   'DE0007276008',
                   'DE000CG49RV5',
                   'DE000A0JEQK6',
                   'DE0006581309',
                   'DE0006620701',
                   'DE0008055021',
                   'AT0000613005',
                   'DE000A0MM6F1',
                   'DE0005280002',
                   'DE000A0Z2334',
                   'DE0008022005',
                   'DE0007100208',
                   'DE0007193500',
                   'DE0002978657',
                   'DE0007062010',
                   'DE000A0PNL64',
                   'DE0005221303',
                   'DE0008292079',
                   'NL0000687705',
                   'DE000A0BVXK3',
                   'DE0002494200',
                   'NL0000887834',
                   'DE0007309007',
                   'DE0005490866',
                   'DE0005660104',
                   'DE0008400029',
                   'CH0001752309',
                   'DE0006579006',
                   'DE0007164030',
                   'DE0007483604',
                   'DE0005032007',
                   'DE000TACL107',
                   'DE000CMBT111',
                   'DE0005223903',
                   'DE000A0EPM07',
                   'DE0005212807',
                   'DE0007201303',
                   'DE0007847303',
                   'DE0007037905',
                   'DE0007454209',
                   'DE0006954001',
                   'DE0008422007',
                   'DE0005494314',
                   'DE0008403007',
                   'US23283K1051',
                   'DE000DFAG997',
                   'DE000A0BVXQ0',
                   'DE0006760002',
                   'FR0000038259',
                   'CH0016458363',
                   'DE0005649503',
                   'DE000A0TGJ71',
                   'DE000A0JQ4J9',
                   'DE0006967607',
                   'DE0005495501',
                   'DE0008041005',
                   'DE000A0LBF86',
                   'DE000A0KFU84',
                   'DE0006223605',
                   'DE0006605009',
                   'AT0000905351',
                   'DE0008435967',
                   'NL0010022315',
                   'DE0007002008',
                   'DE0006081003',
                   'DE0005557706',
                   'DE0006048911',
                   'DE0005098008',
                   'DE0006275001',
                   'DE0005228779',
                   'DE000A1PHC13',
                   'DE0005213508',
                   'AT0000603709',
                   'DE0008124009',
                   'DE0006074800',
                   'IL0010834682',
                   'NL0000233948',
                   'DE0006967805',
                   'CH0012337421',
                   'DE0005880405',
                   'DE0006177033',
                   'IL0010837735',
                   'US8041371076',
                   'DE0005138408',
                   'DE0005441000',
                   'AT0000937503',
                   'DE000A0EPUF5',
                   'DE000A11QU11',
                   'DE0005758007',
                   'DE0007495004',
                   'DE0005088504',
                   'DE0006171069',
                   'AT0000816301',
                   'DE0006910904',
                   'DE000A1E9A75',
                   'DE0006004500',
                   'DE000A0Z24E9',
                   'US7427181091',
                   'DE0007477507',
                   'CAC294121008',
                   'DE0006778905',
                   'DE0005494272',
                   'DE0007163131',
                   'DE0006290208',
                   'DE000A0BVU51',
                   'DE0005016901',
                   'DE0005448807',
                   'USU553961025',
                   'DE0001262152',
                   'DE0005801500',
                   'DE0006911324',
                   'DE0006300734',
                   'DE0007241424',
                   'DE0005061501',
                   'DE0007765638',
                   'DE000A0HN404',
                   'DE0005278006',
                   'DE000A2BPP88',
                   'DE0006051923',
                   'DE000A0Z1LZ7',
                   'DE0006655103',
                   'DE000A0XFUK6',
                   'DE0007608101',
                   'DE0005532907',
                   'DE0005444905',
                   'AT0000720008',
                   'AT0000676903',
                   'DE0005706600',
                   'DE000A1A6WE6',
                   'DE0006873805',
                   'DE0005853030',
                   'DE0006622400',
                   'DE0006034002',
                   'DE0009314864',
                   'DE0006633308',
                   'AT0000910997',
                   'DE000A0KPPA3',
                   'DE0008428004',
                   'DE0006763907',
                   'DE0006334006',
                   'NL0000200525',
                   'DE000A0JCY37',
                   'AT0000926266',
                   'DE0005537005',
                   'DE0005474407',
                   'GB0007192106',
                   'AT0000A0ZHT2',
                   'DE0006180615',
                   'DE0005291405',
                   'CH0012142631',
                   'CH0011247084',
                   'DE0007659336',
                   'DE0005336804',
                   'DE0006303407',
                   'AT0000661350',
                   'DE0006637390',
                   'DE000A1X3W00',
                   'DE0006852809',
                   'DE0006223803',
                   'DE0007830101',
                   'DE0005568174',
                   'DE000SGU8886',
                   'DE0007499303',
                   'DE0005078000',
                   'AT0000705355',
                   'DE0007700205',
                   'DE0007332207',
                   'DE0006853005',
                   'DE000A0WMPN8',
                   'DE0007020703',
                   'DE0005427009',
                   'DE0007241614',
                   'DE000A1K0409',
                   'DE000A0BVVK7',
                   'DE0005410203',
                   'AT0000743059',
                   'DE0007279507',
                   'DE0006211600',
                   'DE0005279806',
                   'AT0000747357',
                   'AT0000620158',
                   'DE0006227309',
                   'DE0005754402',
                   'DE0006352537',
                   'US2787251063',
                   'AT0000808209',
                   'US1114121023',
                   'DE000A1RFMZ1',
                   'DE0005147805',
                   'DE0005192801',
                   'DE0007458804',
                   'DE0007274136',
                   'DE0005085708',
                   'DE0006617400',
                   'DE000A0NK3W4',
                   'DE0006628100']


class ArivaStocksSpider(scrapy.Spider):
    name = 'arivaStocks'
    allowed_domains = ['ariva.de']
    start_url = 'https://www.ariva.de/'
    # handle_httpstatus_list = [301, 302]

    REL_URL_METADATA = '/bilanz-guv#stammdaten'
    REL_URL_HISTORICALDATA = '/historische_kurse'
    CSS_PATH_META_FOUNDINGYEAR = ".stammdaten tr:nth-child(1) td"
    CSS_PATH_META_TICKER = ".stammdaten tr:nth-child(2) td"
    CSS_PATH_META_LISTINGDATE = ".stammdaten tr:nth-child(3) td"
    CSS_PATH_META_COUNTRY = ".stammdaten tr:nth-child(5) td"
    CSS_PATH_META_INDUSTRY = ".stammdaten tr:nth-child(7) td"
    CSS_PATH_META_STOCKTYPE = ".stammdaten tr:nth-child(8) td"
    CSS_PATH_META_SECTOR = ".stammdaten tr:nth-child(9) td"
    XPATH_SECURITYID = '//input[@name="secu"]'
    XPATH_EXCHANGEID = '//input[@name="boerse_id"]'

    BASE_URL_HISTORIC_PRICES = r'http://www.ariva.de/quote/historic/historic.csv'

    def start_requests(self):
        """If spider is started with option -a stock_isins=['ISIN1','ISIN2',...] it will scrape these ISINs"""
        stock_isins = getattr(self, 'stock_isins', None)
        if stock_isins is None:
            stock_isins = ALL_STOCKS_ISIN
        requests = [scrapy.Request(url=''.join([self.start_url, isin]), meta={'isin': isin}, callback=self.parse) for
                    isin in stock_isins]

        for request in requests:
            yield request

    def parse(self, response):
        # Print what the spider is doing
        link = ''.join([response.url, self.REL_URL_METADATA])
        request = response.follow(link, callback=self.parse_stock_metadata)
        self.logger.info('Parse: Got successful response from {}\nNow navigating to {}'.format(response.url, link))
        request.meta['main_url'] = response.url
        request.meta['isin'] = response.meta['isin']  # response.request.url.rsplit(r'/', 1)[-1]  # TODO: doesn't work

        yield request

    def parse_stock_metadata(self, response):
        # Print what the spider is doing
        print(response.url)

        l = ItemLoader(item=ArivaStockItem(), response=response)
        l.add_value('security_name', response.meta['main_url'].rsplit(r'/', 1)[-1])
        l.add_value('isin', response.meta['isin'])
        l.add_css('foundingyear', self.CSS_PATH_META_FOUNDINGYEAR)
        l.add_css('ticker', self.CSS_PATH_META_TICKER)
        l.add_css('listingdate', self.CSS_PATH_META_LISTINGDATE)
        l.add_css('country', self.CSS_PATH_META_COUNTRY)
        l.add_css('industry', self.CSS_PATH_META_INDUSTRY)
        l.add_css('stocktype', self.CSS_PATH_META_STOCKTYPE)
        l.add_css('sector', self.CSS_PATH_META_SECTOR)
        link = ''.join([response.meta['main_url'], self.REL_URL_HISTORICALDATA])

        request = response.follow(link, callback=self.parse_stock_prices)
        request.meta['item'] = l
        self.logger.info('Parse stock_metadata: successful response from {}\nNow navigating to {}'.format(
            response.url, link))

        yield request

    def parse_stock_prices(self, response):
        # Print what the spider is doing
        print(response.url)
        item = response.meta['item']
        secuid = response.xpath(self.XPATH_SECURITYID).attrib['value']
        print('secuid', secuid)
        item.add_value('arivaID', secuid)
        exchangeid = response.xpath(self.XPATH_EXCHANGEID).attrib['value']

        item.add_value('exchangeID', exchangeid)
        start_date = '2000-01-01'
        end_date = datetime.today().strftime('%Y-%m-%d')
        stock_params_url = '?secu={}&boerse_id={}&clean_split=1&clean_payout=1&clean_bezug=1&min_time={}&max_time={}' \
                           '&trenner=%3B&go=Download' \
            .format(secuid, exchangeid, start_date, end_date)
        file_url = ''.join([self.BASE_URL_HISTORIC_PRICES, stock_params_url])
        item.add_value('file_urls', file_url)

        return item.load_item()
